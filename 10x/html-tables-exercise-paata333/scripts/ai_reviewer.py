import os
import json
import requests
import google.generativeai as genai

# Configuration: Extensions to look for (add more if needed)
# Configuration: Comprehensive Frontend & Backend Extensions
SUPPORTED_EXTENSIONS = {
    # JavaScript / TypeScript & Flavors
    '.js', '.jsx', '.ts', '.tsx', '.mjs', '.cjs',
    
    # Modern Frameworks
    '.vue', '.svelte', '.astro',
    
    # Styling
    '.css', '.scss', '.sass', '.less', '.styl',
    
    # Markup & Templates
    '.html', '.htm', '.pug', '.ejs', '.handlebars', '.hbs',
    
    # Backend / Other (Optional, keep if you have full-stack repos)
    '.json', '.go', '.java', '.cpp', '.c' , '.md'
}

# Directories to ignore (Added common frontend folders like dist, build, coverage)
IGNORE_DIRS = {
    '.git', '.github', '.vscode', '.idea', 
    'node_modules', 'bower_components', 
    'dist', 'build', 'out', 'coverage', 
    '__pycache__', 'venv', 'bin', 'obj', 
    '.next', '.nuxt', '.astro' # Framework build caches
}

def main():
    # --- 1. SETUP ---
    gemini_key = os.getenv("GEMINI_API_KEY")
    github_token = os.getenv("GITHUB_TOKEN")

    if not gemini_key or not github_token:
        print("РЮї Error: Missing API Key or Token.")
        return

    genai.configure(api_key=gemini_key)
    # Using 1.5 Pro is critical here because it has a huge context window (1M+ tokens)
    model = genai.GenerativeModel("gemini-2.5-pro") 

    # --- 2. GET CONTEXT ---
    repo_full_name = os.getenv("GITHUB_REPOSITORY")
    event_path = os.getenv("GITHUB_EVENT_PATH")
    
    with open(event_path, 'r') as f:
        event_data = json.load(f)
    
    # Handle both PR events and Manual Dispatch events
    if 'pull_request' in event_data:
        pr_number = event_data['pull_request']['number']
    else:
        # If run manually without a PR context, we might default to posting an Issue (optional logic)
        print("Рџа№ИЈ Not a Pull Request event. Ensure this runs in a PR context for comments.")
        return

    # --- 3. READ ALL FILES FROM DISK ---
    print("­ЪЊѓ Reading entire project codebase...")
    
    codebase_content = ""
    file_count = 0
    
    # Walk through the current directory (which is the student's repo root)
    for root, dirs, files in os.walk("."):
        # Remove ignored directories to speed up walking
        dirs[:] = [d for d in dirs if d not in IGNORE_DIRS]
        
        for file in files:
            ext = os.path.splitext(file)[1]
            if ext in SUPPORTED_EXTENSIONS:
                file_path = os.path.join(root, file)
                
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        content = f.read()
                        # Add file header so AI knows which file is which
                        codebase_content += f"\n--- FILE: {file_path} ---\n"
                        codebase_content += content
                        codebase_content += "\n"
                        file_count += 1
                except Exception as e:
                    print(f"Рџа№ИЈ Skipped {file_path}: {e}")

    print(f"РюЁ Loaded {file_count} files.")

    if file_count == 0:
        print("РЮї No valid source code files found to review.")
        return

    # --- 4. THE PROMPT (FULL PROJECT REVIEW) ---
    prompt = f"""
рЃерЃћрЃюрЃў рЃарЃЮрЃџрЃўрЃљ рЃўрЃДрЃЮ рЃњрЃљрЃЏрЃЮрЃфрЃЊрЃўрЃџрЃў, рЃЏрЃ«рЃљрЃарЃЊрЃљрЃЏрЃГрЃћрЃарЃў рЃЊрЃљ рЃћрЃЏрЃърЃљрЃЌрЃўрЃБрЃарЃў рЃЦрЃљрЃарЃЌрЃЋрЃћрЃџрЃў рЃърЃарЃЮрЃњрЃарЃљрЃЏрЃўрЃарЃћрЃЉрЃўрЃА рЃЏрЃћрЃюрЃбрЃЮрЃарЃў. рЃерЃћрЃю рЃћрЃАрЃљрЃБрЃЉрЃарЃћрЃЉрЃў рЃЊрЃљрЃЏрЃгрЃДрЃћрЃЉ рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃА.

рЃЦрЃЋрЃћрЃЏрЃЮрЃЌ рЃЏрЃЮрЃфрЃћрЃЏрЃБрЃџрЃўрЃљ рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃўрЃА **рЃЏрЃЌрЃџрЃўрЃљрЃюрЃў рЃърЃарЃЮрЃћрЃЦрЃбрЃў** (рЃЎрЃЮрЃЊрЃў + рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃљрЃдрЃгрЃћрЃарЃљ).

**Рџа№ИЈ рЃЎрЃарЃўрЃбрЃўрЃЎрЃБрЃџрЃљрЃЊ рЃЏрЃюрЃўрЃерЃЋрЃюрЃћрЃџрЃЮрЃЋрЃљрЃюрЃў рЃўрЃюрЃАрЃбрЃарЃБрЃЦрЃфрЃўрЃљ:**
рЃАрЃљрЃюрЃљрЃЏ рЃЎрЃЮрЃЊрЃўрЃА рЃарЃћрЃЋрЃўрЃБрЃА рЃЊрЃљрЃўрЃгрЃДрЃћрЃЉрЃЊрЃћ, рЃерЃћрЃю **рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃБрЃюрЃЊрЃљ рЃЏрЃЮрЃФрЃћрЃЉрЃюрЃЮ рЃЊрЃљ рЃгрЃљрЃўрЃЎрЃўрЃЌрЃ«рЃЮ рЃърЃарЃЮрЃћрЃЦрЃбрЃерЃў рЃљрЃарЃАрЃћрЃЉрЃБрЃџрЃў `.md` рЃњрЃљрЃцрЃљрЃарЃЌрЃЮрЃћрЃЉрЃўрЃА рЃцрЃљрЃўрЃџрЃў** (рЃЏрЃљрЃњ: `README.md`, `TASK.md`, EXERCISE.md рЃљрЃю рЃЏрЃАрЃњрЃљрЃЋрЃАрЃў).
1. рЃњрЃљрЃўрЃљрЃќрЃарЃћ, рЃарЃљ рЃўрЃДрЃЮ рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ? рЃарЃљ рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃў рЃБрЃюрЃЊрЃљ рЃерЃћрЃћрЃАрЃарЃБрЃџрЃћрЃЉрЃўрЃюрЃљ рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃА?
2. рЃерЃћрЃюрЃў рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ рЃЊрЃљрЃљрЃцрЃБрЃФрЃюрЃћ рЃўрЃЏрЃљрЃА, рЃЌрЃБ рЃарЃљрЃЏрЃЊрЃћрЃюрЃљрЃЊ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃерЃћрЃљрЃАрЃарЃБрЃџрЃљ рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃЏрЃљ рЃћрЃА рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃЊрЃљ рЃљрЃарЃљ рЃЏрЃ«рЃЮрЃџрЃЮрЃЊ рЃќрЃЮрЃњрЃљрЃЊ рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃА.

**рЃбрЃЮрЃюрЃљрЃџрЃЮрЃЉрЃљ:** рЃЏрЃћрЃњрЃЮрЃЉрЃарЃБрЃџрЃў, рЃБрЃерЃБрЃљрЃџрЃЮ, рЃЏрЃљрЃњрЃарЃљрЃЏ рЃърЃарЃЮрЃцрЃћрЃАрЃўрЃЮрЃюрЃљрЃџрЃБрЃарЃў. рЃўрЃАрЃћрЃЌрЃў, рЃЌрЃўрЃЌрЃЦрЃЮрЃА рЃњрЃЋрЃћрЃарЃЊрЃўрЃЌ рЃБрЃќрЃўрЃА рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃА рЃЊрЃљ рЃћрЃЎрЃарЃљрЃюрЃќрЃћ рЃБрЃЌрЃўрЃЌрЃћрЃЉрЃА рЃюрЃўрЃБрЃљрЃюрЃАрЃћрЃЉрЃА.

**рЃўрЃњрЃюрЃЮрЃарЃўрЃарЃћрЃЉрЃљ:**
* `/scripts` рЃцрЃЮрЃџрЃЊрЃћрЃарЃў.
* `.github` рЃцрЃЮрЃџрЃЊрЃћрЃарЃў.
* `styles/` рЃцрЃЮрЃџрЃЊрЃћрЃарЃў.

**рЃљрЃюрЃљрЃџрЃўрЃќрЃўрЃА рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ рЃЊрЃљ рЃцрЃЮрЃарЃЏрЃљрЃбрЃў:**

­ЪЊў **рЃюрЃљрЃЉрЃўрЃ»рЃў 1: рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃњрЃљрЃљрЃќрЃарЃћрЃЉрЃљ (Context Check):**
   - рЃЏрЃЮрЃЎрЃџрЃћрЃЊ рЃЊрЃљрЃљрЃЊрЃљрЃАрЃбрЃБрЃарЃћ, рЃарЃЮрЃЏ рЃњрЃљрЃћрЃфрЃљрЃюрЃў рЃърЃўрЃарЃЮрЃЉрЃљрЃА. (рЃЏрЃљрЃњ: "рЃЋрЃюрЃљрЃ«рЃћ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃърЃўрЃарЃЮрЃЉрЃљ, рЃАрЃљрЃЊрЃљрЃф рЃБрЃюрЃЊрЃљ рЃерЃћрЃњрЃћрЃЦрЃЏрЃюрЃљ X рЃцрЃБрЃюрЃЦрЃфрЃўрЃЮрЃюрЃљрЃџрЃў Y рЃЏрЃћрЃЌрЃЮрЃЊрЃўрЃЌ...").
   - рЃЌрЃБ рЃЎрЃЮрЃЊрЃў рЃърЃўрЃарЃЮрЃЉрЃљрЃА рЃљрЃфрЃЊрЃћрЃЉрЃљ, рЃљрЃЏрЃљрЃќрЃћ рЃарЃЉрЃўрЃџрЃљрЃЊ рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћ рЃљрЃЦ.

РюЁ **рЃюрЃљрЃЉрЃўрЃ»рЃў 2: рЃарЃљ рЃЏрЃБрЃерЃљрЃЮрЃЉрЃА рЃЎрЃљрЃарЃњрЃљрЃЊ?**
   - рЃњрЃљрЃЏрЃЮрЃДрЃљрЃЋрЃў 1-2 рЃЏрЃЮрЃЏрЃћрЃюрЃбрЃў, рЃАрЃљрЃЊрЃљрЃф рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃЏрЃљ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃќрЃБрЃАрЃбрЃљрЃЊ рЃљрЃю рЃЎрЃарЃћрЃљрЃбрЃўрЃБрЃџрЃљрЃЊ рЃерЃћрЃљрЃАрЃарЃБрЃџрЃљ.
   - рЃўрЃДрЃљрЃЋрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў! (рЃЏрЃљрЃњ: "рЃЏрЃЮрЃЏрЃћрЃгрЃЮрЃюрЃљ, рЃарЃЮрЃњрЃЮрЃа рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ `map` рЃцрЃБрЃюрЃЦрЃфрЃўрЃљ `script.js`-рЃерЃў рЃЏрЃЮрЃюрЃљрЃфрЃћрЃЏрЃћрЃЉрЃўрЃА рЃЊрЃљрЃАрЃљрЃЏрЃБрЃерЃљрЃЋрЃћрЃЉрЃџрЃљрЃЊ, рЃќрЃБрЃАрЃбрЃљрЃЊ рЃўрЃАрЃћ, рЃарЃЮрЃњрЃЮрЃарЃф рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃљ рЃўрЃЌрЃ«рЃЮрЃЋрЃЊрЃљ").

­ЪћЇ **рЃюрЃљрЃЉрЃўрЃ»рЃў 3: рЃЎрЃЮрЃЊрЃўрЃА рЃЊрЃћрЃбрЃљрЃџрЃБрЃарЃў рЃњрЃљрЃюрЃ«рЃўрЃџрЃЋрЃљ (Deep Dive):**
   - рЃћрЃА рЃљрЃарЃўрЃА рЃЏрЃЌрЃљрЃЋрЃљрЃарЃў рЃюрЃљрЃгрЃўрЃџрЃў. рЃњрЃљрЃўрЃљрЃарЃћ рЃцрЃљрЃўрЃџрЃћрЃЉрЃў рЃЊрЃљ рЃЏрЃўрЃћрЃфрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃерЃћрЃюрЃўрЃерЃЋрЃюрЃћрЃЉрЃў.
   - **рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃџрЃљрЃЊ рЃЊрЃљрЃљрЃЎрЃЮрЃърЃўрЃарЃћ рЃЎрЃЮрЃЊрЃўрЃА рЃЏрЃфрЃўрЃарЃћ рЃцрЃарЃљрЃњрЃЏрЃћрЃюрЃбрЃў**, рЃарЃЮрЃЏрЃћрЃџрЃќрЃћрЃф рЃАрЃљрЃБрЃЉрЃарЃЮрЃЉ рЃЊрЃљ рЃЏрЃўрЃБрЃЌрЃўрЃЌрЃћ рЃцрЃљрЃўрЃџрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў/рЃ«рЃљрЃќрЃў.
   - **рЃАрЃўрЃюрЃбрЃљрЃЦрЃАрЃў рЃЊрЃљ рЃџрЃЮрЃњрЃўрЃЎрЃљ:** рЃюрЃљрЃ«рЃћ, рЃљрЃарЃўрЃА рЃЌрЃБ рЃљрЃарЃљ рЃЎрЃЮрЃЊрЃў рЃЮрЃърЃбрЃўрЃЏрЃўрЃќрЃћрЃЉрЃБрЃџрЃў? рЃўрЃДрЃћрЃюрЃћрЃЉрЃА рЃЌрЃБ рЃљрЃарЃљ рЃЌрЃљрЃюрЃљрЃЏрЃћрЃЊрЃарЃЮрЃЋрЃћ рЃАрЃбрЃљрЃюрЃЊрЃљрЃарЃбрЃћрЃЉрЃА?
     > ­ЪњА *рЃарЃЕрЃћрЃЋрЃљ:* "рЃљрЃЦ рЃ»рЃЮрЃЉрЃўрЃљ рЃњрЃљрЃЏрЃЮрЃЋрЃўрЃДрЃћрЃюрЃЮрЃЌ..." (рЃЊрЃљ рЃљрЃ«рЃАрЃћрЃюрЃў рЃарЃљрЃбрЃЮрЃЏ).

­ЪДа **рЃюрЃљрЃЉрЃўрЃ»рЃў 4: рЃљрЃарЃЦрЃўрЃбрЃћрЃЦрЃбрЃБрЃарЃљ рЃЊрЃљ рЃАрЃбрЃарЃБрЃЦрЃбрЃБрЃарЃљ:**
   - рЃарЃљрЃЏрЃЊрЃћрЃюрЃљрЃЊ рЃАрЃгрЃЮрЃарЃљрЃЊ рЃљрЃарЃўрЃА рЃЊрЃљрЃџрЃљрЃњрЃћрЃЉрЃБрЃџрЃў рЃцрЃљрЃўрЃџрЃћрЃЉрЃў? (рЃЏрЃљрЃњ: CSS рЃфрЃљрЃџрЃЎрЃћрЃљ? HTML рЃАрЃБрЃцрЃЌрЃљрЃљ?).

­Ъџђ **рЃерЃћрЃ»рЃљрЃЏрЃћрЃЉрЃљ рЃЊрЃљ рЃерЃћрЃЏрЃЊрЃћрЃњрЃў рЃюрЃљрЃЉрЃўрЃ»рЃў:**
   - рЃерЃћрЃљрЃ»рЃљрЃЏрЃћ рЃърЃЮрЃќрЃўрЃбрЃўрЃБрЃарЃљрЃЊ.
   - рЃЏрЃўрЃћрЃфрЃў рЃћрЃарЃЌрЃў рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџрЃў рЃарЃћрЃАрЃБрЃарЃАрЃў рЃљрЃю рЃўрЃЊрЃћрЃљ, рЃарЃљрЃф рЃљрЃЏ рЃЊрЃљрЃЋрЃљрЃџрЃћрЃЉрЃўрЃА рЃњрЃљрЃБрЃЏрЃ»рЃЮрЃЉрЃћрЃАрЃћрЃЉрЃљрЃерЃў рЃЊрЃљрЃћрЃ«рЃЏрЃљрЃарЃћрЃЉрЃљ.
   -- **рЃЏрЃЮрЃЎрЃџрЃћ рЃЊрЃљ рЃњрЃљрЃАрЃљрЃњрЃћрЃЉрЃў рЃћрЃюрЃљ** рЃњрЃљрЃЏрЃЮрЃўрЃДрЃћрЃюрЃћ, рЃарЃљрЃЌрЃљ рЃЊрЃљрЃЏрЃгрЃДрЃћрЃЉрЃЏрЃљ рЃАрЃбрЃБрЃЊрЃћрЃюрЃбрЃЏрЃљ рЃЏрЃљрЃарЃбрЃўрЃЋрЃљрЃЊ рЃњрЃљрЃўрЃњрЃЮрЃА.**

**рЃърЃарЃЮрЃћрЃЦрЃбрЃўрЃА рЃцрЃљрЃўрЃџрЃћрЃЉрЃў:**

    {codebase_content}
    """

    # --- 5. SEND TO GEMINI ---
    try:
        ai_response = model.generate_content(prompt)
        feedback_body = ai_response.text
    except Exception as e:
        print(f"РЮї Gemini Error: {e}")
        return

    # --- 6. POST COMMENT ---
    post_comment(repo_full_name, pr_number, github_token, feedback_body)

def post_comment(repo, pr_num, token, body):
    url = f"https://api.github.com/repos/{repo}/issues/{pr_num}/comments"
    headers = {
        "Authorization": f"token {token}",
        "Accept": "application/vnd.github.v3+json"
    }
    data = {"body": f"### ­ЪЈЏ рЃЏрЃЌрЃџрЃўрЃљрЃюрЃў рЃърЃарЃЮрЃћрЃЦрЃбрЃўрЃА рЃерЃћрЃцрЃљрЃАрЃћрЃЉрЃљ (AI)\n\n{body}"}
    requests.post(url, json=data, headers=headers)

if __name__ == "__main__":
    main()
